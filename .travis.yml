sudo: false

branches:
  only:
    - master
    - /^\d+\.\d+\.x$/ # release forked patches branch

os:
  - linux
  - osx

matrix:
  include:
    - python: 2.6
    - python: 2.7
    - language: generic
      os: osx


cache:
  directories:
    - $HOME/virtualenv/python$TRAVIS_PYTHON_VERSION.9
    - vendor/cache

matrix:
  fast_finish: true

env:
  global:
    - CONCURRENCY=2
    - COVERAGE=true
    - NOSE_FILTER="not windows"
    - INTEGRATIONS_DIR=$HOME/embedded
    - PIP_CACHE=$HOME/.cache/pip
    - SKIP_CLEANUP=true
    - VOLATILE_DIR=/tmp
    - DD_CASHER_DIR=/tmp/casher
    - AGENT_VERSION=2.0.5
  matrix:
    - TRAVIS_FLAVOR=default
    - TRAVIS_FLAVOR=core_integration
    - TRAVIS_FLAVOR=checks_mock
    - TRAVIS_FLAVOR=activemq
    - TRAVIS_FLAVOR=apache
    #- TRAVIS_FLAVOR=cassandra FLAVOR_VERSION=2.0.13
    #- TRAVIS_FLAVOR=cassandra FLAVOR_VERSION=2.1.3
    - TRAVIS_FLAVOR=couchdb
    #- TRAVIS_FLAVOR=elasticsearch FLAVOR_VERSION=0.90.13
    #- TRAVIS_FLAVOR=elasticsearch FLAVOR_VERSION=1.0.3
    #- TRAVIS_FLAVOR=elasticsearch FLAVOR_VERSION=1.1.2
    #- TRAVIS_FLAVOR=elasticsearch FLAVOR_VERSION=1.2.4
    #- TRAVIS_FLAVOR=elasticsearch FLAVOR_VERSION=1.3.9
    #- TRAVIS_FLAVOR=elasticsearch FLAVOR_VERSION=1.4.5
    #- TRAVIS_FLAVOR=elasticsearch FLAVOR_VERSION=1.5.2
    #- TRAVIS_FLAVOR=elasticsearch FLAVOR_VERSION=1.6.0
    #- TRAVIS_FLAVOR=etcd
    #- TRAVIS_FLAVOR=fluentd
    #- TRAVIS_FLAVOR=go_expvar
    # FIXME: cannot enable gearman on Travis right now
    # because it needs boost
    # - TRAVIS_FLAVOR=gearman
    #- TRAVIS_FLAVOR=haproxy FLAVOR_VERSION=1.3.27
    #- TRAVIS_FLAVOR=haproxy FLAVOR_VERSION=1.4.26
    #- TRAVIS_FLAVOR=haproxy FLAVOR_VERSION=1.5.11
    - TRAVIS_FLAVOR=lighttpd
    - TRAVIS_FLAVOR=memcache
    - TRAVIS_FLAVOR=mongo FLAVOR_VERSION=2.6.9
    - TRAVIS_FLAVOR=mongo FLAVOR_VERSION=3.0.1
    - TRAVIS_FLAVOR=mysql
    - TRAVIS_FLAVOR=network
    - TRAVIS_FLAVOR=nginx FLAVOR_VERSION=1.6.2
    - TRAVIS_FLAVOR=nginx FLAVOR_VERSION=1.7.11
    #- TRAVIS_FLAVOR=pgbouncer
    - TRAVIS_FLAVOR=phpfpm
    - TRAVIS_FLAVOR=postgres FLAVOR_VERSION=9.0.19
    - TRAVIS_FLAVOR=postgres FLAVOR_VERSION=9.1.15
    - TRAVIS_FLAVOR=postgres FLAVOR_VERSION=9.2.10
    - TRAVIS_FLAVOR=postgres FLAVOR_VERSION=9.3.6
    - TRAVIS_FLAVOR=postgres FLAVOR_VERSION=9.4.1
    - TRAVIS_FLAVOR=rabbitmq
    - TRAVIS_FLAVOR=redis FLAVOR_VERSION=2.4.18
    - TRAVIS_FLAVOR=redis FLAVOR_VERSION=2.6.17
    - TRAVIS_FLAVOR=redis FLAVOR_VERSION=2.8.19
# Compilation takes too much time on Travis
#   - TRAVIS_FLAVOR=riak
    #- TRAVIS_FLAVOR=snmpd
    #- TRAVIS_FLAVOR=ssh
    - TRAVIS_FLAVOR=supervisord
    - TRAVIS_FLAVOR=sysstat
# FIXME: reenable, but right now cannot run on Travis because
# hugepages are enabled
#    - TRAVIS_FLAVOR=tokumx
    #- TRAVIS_FLAVOR=tomcat # JMX testing machine / need the other ones before
    - TRAVIS_FLAVOR=varnish FLAVOR_VERSION=3.0.7
    - TRAVIS_FLAVOR=varnish FLAVOR_VERSION=4.0.3
    #- TRAVIS_FLAVOR=zookeeper

# Override travis defaults with empty jobs
before_install: echo "OVERRIDING TRAVIS STEPS"
install: echo "OVERRIDING TRAVIS STEPS"
before_script: echo "OVERRIDING TRAVIS STEPS"

script:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then cd darwin; ./build_installer.sh; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then ./linux_script.sh; fi


after_failure:
  - echo "Logs from installation process come here / DEBUG LOGS"
  - cat /tmp/ci.log

notifications:
  slack: serverdensity:$SLACK_API_TOKEN

deploy:
  - provider: releases
    api_key:
      secure: WggAIYHmj9OVs2ykRlQT+jMhWZ2N4slwDTHRvSbfy/G+oYAVSA9BzSfqFZTX3A/wSw+mYYOq6uaPk3m6fDYHu2W+zG2VwzstJVt93dUOAuc9b8Rl4WhVf54Ov8jGurzOM6CKrs4KSk1UKNLnH/h8HpUM0TgUzqfLzWkg1q1Df50=
    skip_cleanup: true
    file: darwin/sd-agent-$AGENT_VERSION.dmg
    on:
      repo: serverdensity/sd-agent
      condition: $TRAVIS_OS_NAME == osx
  - provider: s3
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    bucket: sd-agent-upload-test
    region: eu-central-1
    skip_cleanup: true
    local_dir: darwin/diskimage
